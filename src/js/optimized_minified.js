const _screenWidth=window.screen.width,_screenHeight=window.screen.height,_isMobile=window.screen.width<500,_viewportWidth=_isMobile?_screenWidth:320,_totalBlock=9,_boardWidth=_viewportWidth-60,_precision=10;let prizeInBlock=[],openedBlock=[],unopenBlock=[],blockHasPrize=null,maxValueBlock=null,maxValuePrizeIndex=null,round=0!=window.localStorage.getItem("plays")?1:2,openTimes=0!=window.localStorage.getItem("plays")?6:0,buyingPhase=0,outOfPlay=!1,startShowGuide=0,endShowGuide=0,isCheat=!1,normalPrizeValue=0;const _body=document.body,board=document.getElementById("board");let guideText=document.getElementById("guide-text"),playTimesIndicator=document.getElementById("play-times-indicator"),round1Indicator=document.getElementById("round1-content"),round1IndicatorContent=document.getElementById("play-times"),round2Indicator=document.getElementById("round2-content"),round2IndicatorContent=document.getElementById("round2-play-times");generatePlayerID=(()=>{let e=document.getElementById("player-id"),t=firebase.firestore(),o=new Date,n=String(o.getDate()).padStart(2,"0"),a=String(o.getMonth()+1).padStart(2,"0"),l=o.getFullYear(),i=o.getHours(),s=o.getMinutes(),d=o.getSeconds();if(window.localStorage.getItem("playerID"))e.innerHTML=window.localStorage.getItem("playerID"),t.collection("player").doc(window.localStorage.getItem("playerID")).update({lastTimeStartPlaying:`${i}:${s}:${d}-${n}/${a}/${l}`,lastStatus:"Chơi lần "+(parseInt(window.localStorage.getItem("playtimes"))+1)+"-"+(parseInt(window.localStorage.getItem("plays"))>0?"playable":"outOfPlay"),playTimes:parseInt(window.localStorage.getItem("playtimes"))+1}).then(()=>{console.log("Document successfully written!")}).catch(e=>{console.error("Error writing document: ",e)}),window.localStorage.setItem("playtimes",parseInt(window.localStorage.getItem("playtimes"))+1);else{let o="";for(let e=0;e<6;e++){o+=`${randomNumber(10)}`}window.localStorage.setItem("playerID",o),window.localStorage.setItem("playtimes",1),e.innerHTML=o,t.collection("player").doc(o).set({joinDate:`${i}:${s}:${d}-${n}/${a}/${l}`,playTimes:1}).then(()=>{console.log("Document successfully written!")}).catch(e=>{console.error("Error writing document: ",e)})}}),shareFacebook=(()=>{FB.ui({method:"share",href:"https://www.facebook.com/lupucoffee/posts/293387488926221"},function(e){var t=byID("game-menu");window.localStorage.setItem("shareFacebook",!0),t.className+=" hide",magicKey(),clickOnPlay=1,setTimeout(function(){t.style.zIndex=-1e3},200)}),endShowGuide=getTimeData(),gtag("event","Tap On Button",{button_label:"Share facebook"}),gtag("event","Read Content",{popup_n_time:getInteractionTime(startShowGuide,endShowGuide)<3?"Share facebook < 3s":"Share facebook > 3s"})}),playGame=(()=>{if("true"!=window.localStorage.getItem("shareFacebook")){document.getElementById("facebook-share-dialog").className+=" show",startShowGuide=getTimeData()}else{var e=byID("game-menu");e.className+=" hide",magicKey(),clickOnPlay=1,setTimeout(function(){e.style.zIndex=-1e3},200)}gtag("event","Tap On Button",{button_label:"Play"})}),showTerms=(()=>{document.getElementById("term-dialog").className+=" show",gtag("event","Tap On Button",{button_label:"Show terms"})}),closeTerms=(()=>{let e=document.getElementById("term-dialog");e.className+=" hide",setTimeout(()=>{e.className="share-facebook-dialog"},350),gtag("event","Tap On Button",{button_label:"Close terms"})}),showPolicy=(()=>{document.getElementById("policy-dialog").className+=" show",gtag("event","Tap On Button",{button_label:"Show policy"})}),closePolicy=(()=>{let e=document.getElementById("policy-dialog");e.className+=" hide",setTimeout(()=>{e.className="share-facebook-dialog"},350),gtag("event","Tap On Button",{button_label:"Close policy"})}),magicKey=(()=>{let e=firebase.firestore();var t=window.location.href,o=new URL(t).searchParams.get("code"),n=byID("game-board");if(o)if(window.localStorage.getItem(o))createBoard(),n.className+=" show",console.log("out of plays");else{e.collection("codes").doc(o).get().then(t=>{if(t.data())round=2,openTimes=0,window.localStorage.setItem("plays",0),isCheat=!0,createBoard(),n.className+=" show",console.log("out of plays firestore");else{let t=CryptoJS.AES.decrypt(o,"LUPUCOFFE").toString(CryptoJS.enc.Utf8);t.includes("add 1 play")?(window.localStorage.setItem("plays",1),round=1,openTimes=6):t.includes("add 2 play")?(window.localStorage.setItem("plays",2),round=1,openTimes=6):t.includes("add 3 play")?(window.localStorage.setItem("plays",3),round=1,openTimes=6):t.includes("add 4 play")?(window.localStorage.setItem("plays",4),round=1,openTimes=6):t.includes("add 5 play")?(window.localStorage.setItem("plays",5),round=1,openTimes=6):t.includes("add 6 play")?(window.localStorage.setItem("plays",6),round=1,openTimes=6):t.includes("add 7 play")?(window.localStorage.setItem("plays",7),round=1,openTimes=6):t.includes("add 8 play")?(window.localStorage.setItem("plays",8),round=1,openTimes=6):t.includes("add 9 play")?(window.localStorage.setItem("plays",9),round=1,openTimes=6):t.includes("add 10 play")?(window.localStorage.setItem("plays",10),round=1,openTimes=6):t.includes("add 11 play")?(window.localStorage.setItem("plays",11),round=1,openTimes=6):t.includes("add 12 play")?(window.localStorage.setItem("plays",12),round=1,openTimes=6):t.includes("add 13 play")?(window.localStorage.setItem("plays",13),round=1,openTimes=6):t.includes("add 14 play")?(window.localStorage.setItem("plays",14),round=1,openTimes=6):t.includes("add 15 play")?(window.localStorage.setItem("plays",15),round=1,openTimes=6):t.includes("add 16 play")?(window.localStorage.setItem("plays",16),round=1,openTimes=6):t.includes("add 17 play")?(window.localStorage.setItem("plays",17),round=1,openTimes=6):t.includes("add 18 play")&&(window.localStorage.setItem("plays",18),round=1,openTimes=6),window.localStorage.setItem(o,!1),e.collection("codes").doc(o).set({status:!1}).then(()=>{console.log("Document successfully written!")}).catch(e=>{console.error("Error writing document: ",e)}),createBoard(),n.className+=" show"}})}else createBoard(),n.className+=" show"}),redirectToFacebook=(()=>{0==window.localStorage.getItem("plays")&&1==outOfPlay?(gtag("event","Tap On Button",{button_label:"Order (out of plays)"}),gtag("event","User Type",{user_type:"Nice user (out of plays)"})):0==window.localStorage.getItem("plays")&&0==outOfPlay&&(gtag("event","Tap On Button",{button_label:"Order"}),gtag("event","User Type",{user_type:"Nice user"})),window.location.href=maxValuePrizeIndex?`https://m.me/lupucoffee?ref=${prizes[maxValuePrizeIndex].value}`:"https://m.me/lupucoffee?ref=minigameorder"}),getTimeData=(()=>{return(new Date).getTime()}),getInteractionTime=((e,t)=>{let o=t-e,n=Math.floor(o/1e3),a=Math.floor(o/1e3/60),l=Math.floor(o/1e3/60/60);return console.log(o),`${l}:${a}:${n}`}),randomNumber=(e=>Math.floor(Math.random()*e)),shufflePrize=(()=>{setTimeout(()=>{let e=randomNumber(10);prizeInBlock.length!=Object.keys(prizes).length&&(prizeInBlock.includes(e)||0==e||(prizeInBlock.push(e),console.log(e)),shufflePrize())},0)}),getNotYetOpenedBlock=(()=>{let e=[];for(let t=1;t<=9;t++)openedBlock.includes(t)||e.push(t);return e}),showPrize=(e=>{document.getElementById(`block-${e}`).className+=" show-prize"}),hidePrize=(e=>{let t=document.getElementById(`block-${e}`);t.className="block",setTimeout(()=>{t.className+=" show-revert"},0)}),removePrize=(e=>{document.getElementById(`block-${e}-prize`).remove()}),hidePopup=(()=>{let e=document.getElementById("popup"),t=document.getElementById("popup-content");if(2==round){let e=getNotYetOpenedBlock();if(openTimes>0){for(let t=0;t<e.length;t++)showPrize(e[t]);setTimeout(()=>{for(let t=0;t<e.length;t++){let o=document.getElementById(`block-${e[t]}-prize`);e[t]!=maxValueBlock&&(o.className="hide")}setTimeout(()=>{for(let t=0;t<e.length;t++)hidePrize(e[t]);setTimeout(()=>{for(let t=0;t<e.length;t++)removePrize(e[t]);setTimeout(()=>{setTimeout(()=>{let t=randomNumber(3),o=randomNumber(3);console.log(t),console.log(o);let n=document.getElementById(`block-${e[t]}`);n.innerHTML+=`<img \n                                    alt="lupu coffee"\n                                    id="block-${e[t]}-prize"\n                                    src="${prizes[0==o?1:o].img}" \n                                    data-value= ${prizes[0==o?1:o].value}\n                                />`,n.className="block stay",e.splice(e.indexOf(e[t]),1)},1e3),guideText.className+=" show",playTimesIndicator.className+=" show"},500)},200)},1500)},2e3)}else if(1!=buyingPhase)blockHasPrize.className="block show",setTimeout(()=>{blockHasPrize.className+=" show-prize",setTimeout(()=>{let e=document.getElementById("popup-button"),o=document.getElementById("popup-label"),n=window.localStorage,a="",l=firebase.firestore(),i=new Date,s=String(i.getDate()).padStart(2,"0"),d=String(i.getMonth()+1).padStart(2,"0"),r=i.getFullYear(),c=i.getHours(),m=i.getMinutes(),u=i.getSeconds();a=normalPrizeValue>0&&normalPrizeValue<5?"LUPU tặng thêm 4k, Tổng là 10k":"LUPU tặng thêm 5k, Tổng là 10k",guideText.className="guide-text",playTimesIndicator.className="play-times-indicator",o.setAttribute("src","src/images/optimized/tinified/out-of-plays.png"),e.setAttribute("src","src/images/optimized/tinified/agree-order-button.png"),t.innerHTML=`Một ly Trà Mật Rừng hoặc Phin Sữa Nâu sẽ giúp bạn thêm lượt. Bạn hiện có ${5+normalPrizeValue}k. ${a} Nếu bạn không sử dụng sẽ bị mất, bạn có muốn order không? `,buyingPhase=1,n.setItem("plays",0),n.setItem("currentPrize",10+normalPrizeValue),showPopup(),gtag("event","Tap On Button",{button_label:"Agree to order"}),l.collection("player").doc(window.localStorage.getItem("playerID")).update({lastTimeFinishPlaying:`${c}:${m}:${u}-${s}/${d}/${r}`,prize:`Đã tặng 5k, lật trúng kẹo ${normalPrizeValue}k, ${a}`}).then(()=>{console.log("Document successfully written!")}).catch(e=>{console.error("Error writing document: ",e)})},1500)},1e3);else{let e=document.getElementById("products"),t=document.getElementById("buying-info");e.className+=" show",t.className+=" show",endShowGuide=getTimeData(),gtag("event","Read Content",{popup_n_time:getInteractionTime(startShowGuide,endShowGuide)<3?"Buying < 3s":"Buying > 3s"})}}else setTimeout(()=>{guideText.className+=" show",playTimesIndicator.className+=" show"},500);1!=buyingPhase&&(e.className+=" hide",endShowGuide=getTimeData(),setTimeout(()=>{e.className="popup",gtag("event","Read Content",{popup_n_time:getInteractionTime(startShowGuide,endShowGuide)<3?`Guide round ${round} < 3s`:`Guide round ${round} > 3s`})},1e3))}),showPopup=(()=>{let e=document.getElementById("popup"),t=document.getElementById("popup-label"),o=document.getElementById("popup-content"),n=getNotYetOpenedBlock();if(2==round)if(0==openTimes)if(1!=buyingPhase)t.setAttribute("src","src/images/optimized/tinified/sorry.png"),o.innerHTML="Bạn đã chọn không đúng rồi. Bây giờ LUPU sẽ cho bạn thấy phần thường của bạn nằm ở viên kẹo nào nhé",setTimeout(()=>{e.className+=" show",setTimeout(()=>{let e=randomNumber(2);(blockHasPrize=document.getElementById(`block-${n[e]}`)).innerHTML+=`<img \n                            alt="lupu coffee"\n                            id="block-${maxValueBlock}-prize"\n                            src="${prizes[maxValuePrizeIndex].img}" \n                        />`},500)},1e3);else{let t=document.getElementById("tooltip");e.className+=" show",setTimeout(()=>{t.className+=" show",setTimeout(()=>{t.className+=" hide"},1500)},2500),gtag("event","Game Rounds",{game_round:"Buying"})}else{let a=0,l=null,i=null;for(let e=0;e<n.length;e++){let t=document.getElementById(`block-${n[e]}-prize`);parseInt(t.dataset.value)>a&&(a=parseInt(t.dataset.value),l=n[e],i=parseInt(t.dataset.prizeIndex),console.log(i))}maxValueBlock=l,maxValuePrizeIndex=i,t.setAttribute("src","src/images/optimized/tinified/round-2.png"),o.innerHTML=`LUPU sẽ giữ lại viên có giá ${prizes[maxValuePrizeIndex].value}k và hoán đổi giá trị với hai viên còn lại (1 viên rỗng, 1 viên có mệnh giá ngẫu nhiên). Chúc bạn may mắn.`,e.className+=" show",startShowGuide=getTimeData(),gtag("event","Game Rounds",{game_round:"Round 2"})}else e.className+=" show",startShowGuide=getTimeData(),gtag("event","Game Rounds",{game_round:"Round 1"})}),createBlock=((e=null,t=null)=>(console.log(t),`\n        <div class="block" id="block-${e}" onclick="blockTap(${e})">   \n            <img \n                alt="lupu coffee"\n                id="block-${e}-prize"\n                src="${prizes[t].img}" \n                data-value="${prizes[t].value}" \n                data-prize-index = "${t}"\n            />\n\n            <div class="candy" id="block-${e}-candy">\n                <img\n                    alt="lupu coffee"\n                    src="src/images/optimized/tinified/block-${e}.png"  \n                />\n            </div>\n        </div>    \n    `)),showBlock=((e=1)=>{setTimeout(()=>{if(document.getElementById(`block-${e}`).className+=" show",++e<=9)showBlock(e);else{const e=document.getElementById("round-1");setTimeout(()=>{e.className+=" show",setTimeout(()=>{e.className="round-label",setTimeout(()=>{showPopup()},200)},1500)},100)}},120)}),hideBlocks=(()=>{for(let e=0;e<openedBlock.length;e++){document.getElementById(`block-${openedBlock[e]}`).className+=" hide"}}),round1LogicTap=(e=>{let t=document.getElementById(`block-${e}`);showPrize(e),openedBlock.push(e),openTimes--,round1IndicatorContent.innerHTML=openTimes,console.log(openTimes),t.setAttribute("onlick",""),0==openTimes&&setTimeout(()=>{hideBlocks(),setTimeout(()=>{const e=document.getElementById("round-2");e.className+=" show",setTimeout(()=>{e.className="round-label",round=2,openTimes=1,guideText.className="guide-text",playTimesIndicator.className="play-times-indicator",setTimeout(()=>{showPopup(),round1Indicator.className="",round2IndicatorContent.innerHTML=openTimes,round2Indicator.className="show",guideText.innerHTML="Ba viên kẹo này đã bị hoán đổi giá trị cho nhau. Bạn chỉ được chọn 1 trong 3."},200)},1500)},1e3)},2e3)}),round2LogicTap=(e=>{let t=document.getElementById("round2-play-times"),o=document.getElementById(`block-${e}-prize`);o&&(normalPrizeValue=parseInt(o.getAttribute("data-value"))),showPrize(e),openedBlock.push(e),openTimes--,t.innerHTML=openTimes,showPopup()}),blockTap=(e=>{1==round&&openTimes>0?round1LogicTap(e):2==round&&openTimes>0&&round2LogicTap(e)}),createBoard=(()=>{let e="";for(let t=1;t<=9;t++)e+=createBlock(t,prizeInBlock[t-1]);if(e+='<div class="round-label" id="round-1"><img src="src/images/optimized/tinified/round-1.png" alt="lupu coffee"/></div>',e+='<div class="round-label" id="round-2"><img src="src/images/optimized/tinified/round-2.png" alt="lupu coffee"/></div>',e+='<div class="board-shadow"></div>',e+='<div id="popup" class="popup">\n                <div class="wrapper">\n                    <img src="src/images/optimized/tinified/before-u-play.png" alt="lupu coffee"/>\n                    <div class="content">\n                        <div class="img-holder"><img id="popup-label" src="src/images/optimized/tinified/round-1.png" alt ="lupu coffee"/></div>\n                        <p id="popup-content">Mỗi viên kẹo được sắp xếp ngẫu nhiên với giá 1k, 5k, 10k, 25k, 100k, 200k, 300k và 400k . Bạn phải bỏ đi 6 viên chỉ giữ lại 3 cho vòng sau.</p>\n                        <div class="button" onclick="hidePopup()"><img id="popup-button" src="src/images/optimized/tinified/agree-button.png" alt ="lupu coffee"/></div>\n                        <div class="products" id="products">\n                            <div class="frame">\n                                <div class="wrapper" id="slider">\n                                    <img src="src/images/optimized/tinified/product-2.png"/>\n                                    <img src="src/images/optimized/tinified/product-1.png"/>\n                                    <div class="tooltips" id="tooltip">\n                                        Quẹt sang phải để xem thêm bạn nhé!\n                                    </div>\n                                </div>\n                            </div> \n                        </div>\n                    </div>\n                </div>\n            </div>',board.innerHTML=e,0!=window.localStorage.getItem("plays"))showBlock();else{let e=document.getElementById("popup-button"),t=document.getElementById("popup-content"),o=document.getElementById("popup-label");guideText.className="guide-text",playTimesIndicator.className="play-times-indicator",o.setAttribute("src","src/images/optimized/tinified/out-of-plays.png"),e.setAttribute("src","src/images/optimized/tinified/agree-order-button.png"),isCheat?(t.innerHTML="Mã code này đã được sử dụng. Đặt ngay một ly Trà Mật Rừng hoặc Phin Sữa Nâu của LUPU bạn sẽ có thêm 1 lượt chơi. LUPU tặng bạn 5k và giảm đến 20% khi order nhé!",gtag("event","User Type",{user_type:"Cheated"})):(t.innerHTML="Bạn đã hết lượt rồi? Chỉ cần đặt một ly Trà Mật Rừng hoặc Phin Sữa Nâu của LUPU bạn sẽ có thêm 1 lượt chơi. LUPU tặng bạn 5k và giảm đến 20% khi order nhé! ",gtag("event","User Type",{user_type:"Out of plays"})),outOfPlay=!0,buyingPhase=1,showPopup()}}),shufflePrize(),body.onload=(e=>{body.style.fontSize=Math.round(1==_isMobile?13*_screenWidth/320:13)+"px",board.style.width=_boardWidth,board.style.height=_boardWidth,generatePlayerID()});